<UserControl x:Class="HavenSoft.HexManiac.WPF.Controls.LLMPanel"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="clr-namespace:HavenSoft.HexManiac.WPF.Controls"
      xmlns:hmar="clr-namespace:HavenSoft.HexManiac.WPF.Resources"
      xmlns:hsi="clr-namespace:HavenSoft.HexManiac.WPF.Implementations"
      Background="{DynamicResource Background}">
   <UserControl.Resources>
      <BooleanToVisibilityConverter x:Key="BoolToVisibility" />
      <hsi:BooleanConverter x:Key="InverseBoolToVisibility" True="Collapsed" False="Visible" />
   </UserControl.Resources>
   <Grid>
      <Grid.RowDefinitions>
         <RowDefinition Height="Auto"/>
         <RowDefinition Height="*"/>
         <RowDefinition Height="Auto"/>
         <RowDefinition Height="Auto"/>
      </Grid.RowDefinitions>

      <!-- Header with close button and API key -->
      <Grid Grid.Row="0" Margin="5">
         <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
         </Grid.ColumnDefinitions>
         <TextBlock Text="API Key:" VerticalAlignment="Center" Foreground="{DynamicResource Primary}" Margin="0,0,5,0"/>
         <PasswordBox Grid.Column="1" x:Name="ApiKeyBox" PasswordChanged="ApiKeyChanged"
                      Background="{DynamicResource Background}" Foreground="{DynamicResource Primary}"
                      BorderBrush="{DynamicResource Backlight}" Margin="0,0,5,0"/>
         <Button Grid.Column="2" Command="{hmar:MethodCommand Close}" Width="20" Height="20">
            <Path Data="{hmar:Icon Exit}" Fill="{DynamicResource Secondary}" Stretch="Uniform"/>
         </Button>
      </Grid>

      <!-- Messages list -->
      <ScrollViewer Grid.Row="1" x:Name="MessagesScroller" VerticalScrollBarVisibility="Auto" Margin="5">
         <StackPanel>
         <ItemsControl ItemsSource="{Binding Messages}">
            <ItemsControl.ItemTemplate>
               <DataTemplate>
                  <Border Margin="0,0,0,10" Padding="8" CornerRadius="4"
                          Background="{DynamicResource Backlight}">
                     <StackPanel>
                        <!-- Role indicator -->
                        <TextBlock FontWeight="Bold" Margin="0,0,0,4"
                                   Foreground="{DynamicResource Accent}"
                                   Text="{Binding Role}"/>
                        <!-- Content -->
                        <TextBlock Text="{Binding Content}" TextWrapping="Wrap"
                                   Foreground="{DynamicResource Primary}"/>
                        <!-- Script code if present -->
                        <Border Visibility="{Binding HasScript, Converter={StaticResource BoolToVisibility}}"
                                Background="{DynamicResource Background}" Margin="0,8,0,0" Padding="8" CornerRadius="2">
                           <StackPanel>
                              <TextBlock Text="Generated Script:" FontWeight="Bold" Margin="0,0,0,4"
                                         Foreground="{DynamicResource Secondary}"/>
                              <TextBox Text="{Binding ScriptCode, Mode=OneWay}" IsReadOnly="True"
                                       FontFamily="Consolas" TextWrapping="Wrap"
                                       Background="Transparent" BorderThickness="0"
                                       Foreground="{DynamicResource Primary}"/>
                           </StackPanel>
                        </Border>
                        <!-- Execution result -->
                        <TextBlock Visibility="{Binding IsExecuted, Converter={StaticResource BoolToVisibility}}"
                                   Text="{Binding ExecutionResult}" Margin="0,4,0,0"
                                   Foreground="{DynamicResource Secondary}" FontStyle="Italic"/>
                     </StackPanel>
                  </Border>
               </DataTemplate>
            </ItemsControl.ItemTemplate>
         </ItemsControl>

         <!-- Loading indicator -->
         <Border Margin="0,0,0,10" Padding="8" CornerRadius="4"
                 Background="{DynamicResource Backlight}"
                 Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibility}}">
            <StackPanel>
               <TextBlock FontWeight="Bold" Margin="0,0,0,4"
                          Foreground="{DynamicResource Accent}"
                          Text="Assistant"/>
               <StackPanel Orientation="Horizontal">
                  <TextBlock Text="Thinking" Foreground="{DynamicResource Secondary}" FontStyle="Italic"/>
                  <TextBlock x:Name="LoadingDots" Text="..." Foreground="{DynamicResource Secondary}" FontStyle="Italic">
                     <TextBlock.Style>
                        <Style TargetType="TextBlock">
                           <Style.Triggers>
                              <DataTrigger Binding="{Binding IsProcessing}" Value="True">
                                 <DataTrigger.EnterActions>
                                    <BeginStoryboard>
                                       <Storyboard RepeatBehavior="Forever">
                                          <StringAnimationUsingKeyFrames Storyboard.TargetProperty="Text" Duration="0:0:1.5">
                                             <DiscreteStringKeyFrame Value="." KeyTime="0:0:0"/>
                                             <DiscreteStringKeyFrame Value=".." KeyTime="0:0:0.5"/>
                                             <DiscreteStringKeyFrame Value="..." KeyTime="0:0:1"/>
                                          </StringAnimationUsingKeyFrames>
                                       </Storyboard>
                                    </BeginStoryboard>
                                 </DataTrigger.EnterActions>
                              </DataTrigger>
                           </Style.Triggers>
                        </Style>
                     </TextBlock.Style>
                  </TextBlock>
               </StackPanel>
            </StackPanel>
         </Border>
         </StackPanel>
      </ScrollViewer>

      <!-- Error message -->
      <TextBlock Grid.Row="2" Text="{Binding ErrorMessage}" Foreground="Red"
                 Margin="5,0" Visibility="{Binding HasError, Converter={StaticResource BoolToVisibility}}"/>

      <!-- Input area -->
      <Grid Grid.Row="3" Margin="5">
         <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
         </Grid.ColumnDefinitions>
         <TextBox x:Name="InputBox" Text="{Binding InputText, UpdateSourceTrigger=PropertyChanged}"
                  AcceptsReturn="False" TextWrapping="Wrap" MaxHeight="100"
                  VerticalScrollBarVisibility="Auto"
                  Background="{DynamicResource Background}" Foreground="{DynamicResource Primary}"
                  BorderBrush="{DynamicResource Backlight}"
                  PreviewKeyDown="InputKeyDown"/>
         <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="5,0,0,0">
            <local:AngleButton Content="Send" Direction="Out" Height="24" Width="60"
                               Command="{Binding SendCommand}"
                               Visibility="{Binding IsProcessing, Converter={StaticResource InverseBoolToVisibility}}"/>
            <local:AngleButton Content="Cancel" Direction="Out" Height="24" Width="60"
                               Command="{Binding CancelCommand}"
                               Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVisibility}}"/>
         </StackPanel>
      </Grid>
   </Grid>
</UserControl>
